<html xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:MSHelp="http://msdn.microsoft.com/mshelp" xmlns:mshelp="http://msdn.microsoft.com/mshelp" xmlns:ddue="http://ddue.schemas.microsoft.com/authoring/2003/5" xmlns:msxsl="urn:schemas-microsoft-com:xslt"><head><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8" /><META NAME="save" CONTENT="history" /><title>Использование встроенной проверки подлинности по протоколу Kerberos для соединения с SQL Server</title><meta name="Language" content="ru-RU" /><meta name="Microsoft.Help.Id" content="687802dc-042a-4363-89aa-741685d165b3" /><meta name="Description" content="Начиная с версии Драйвер Microsoft JDBC 4.0 для SQL Server, приложение может с помощью свойства соединения authenticationScheme указать, что соединение с базой данных должно выполняться с использованием встроенной проверки подлинности Kerberos типа 4." /><meta name="Microsoft.Help.ContentType" content="Concepts" /><link rel="stylesheet" type="text/css" href="../local/Classic.css" /><script type="text/javascript" src="../scripts/EventUtilities.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/SplitScreen.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/Dropdown.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/script_manifold.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/script_feedBack.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/CheckboxMenu.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/CommonUtilities.js">&amp;nbsp;</script><script type="text/javascript" src="../local/script_main.js">&amp;nbsp;</script></head><body><div id="header"><table id="bottomTable" cellpadding="0" cellspacing="0"><tr><td align="left"><span id="headerBold">Использование встроенной проверки подлинности по протоколу Kerberos для соединения с SQL Server</span></td></tr></table><table id="gradientTable"><tr><td class="nsrBottom" background="../icons/gradient.gif" /></tr></table></div><div id="mainSection"><div id="mainBody"><div class="introduction"><p>Начиная с версии Драйвер Microsoft JDBC 4.0 для SQL Server, приложение может с помощью свойства соединения <span sdata="langKeyword" value="authenticationScheme"><span class="keyword">authenticationScheme</span></span> указать, что соединение с базой данных должно выполняться с использованием встроенной проверки подлинности Kerberos типа 4. Дополнительные сведения о свойствах приложения см. в разделе <span sdata="link"><a href="f1b62700-f046-488d-bd6b-a5cd8fc345b7.htm">Задание свойств соединения</a></span>. Дополнительные сведения о протоколе Kerberos см. в разделах <a href="http://go.microsoft.com/fwlink/?LinkId=101449">Технические дополнения по протоколу Kerberos для Windows</a> и <a href="http://go.microsoft.com/fwlink/?LinkID=100758">Microsoft Kerberos</a>.</p><p>При использовании встроенной проверки подлинности в модуле Java <span sdata="langKeyword" value="Krb5LoginModule"><span class="keyword">Krb5LoginModule</span></span> модуль можно настроить с помощью класса <a href="http://download.oracle.com/javase/1.5.0/docs/guide/security/jaas/spec/com/sun/security/auth/module/Krb5LoginModule.html">Krb5LoginModule</a>.</p><p>Драйвер Драйвер Microsoft JDBC для SQL Server устанавливает для виртуальных машин Java для IBM следующие свойства:</p><ul><li><p><span sdata="langKeyword" value="useDefaultCcache = true"><span class="keyword">useDefaultCcache = true</span></span></p></li><li><p><span sdata="langKeyword" value="moduleBanner = false"><span class="keyword">moduleBanner = false</span></span></p></li></ul><p>Драйвер Драйвер Microsoft JDBC для SQL Server устанавливает для всех остальных машин Java следующие свойства:</p><ul><li><p><span sdata="langKeyword" value="useTicketCache = true"><span class="keyword">useTicketCache = true</span></span></p></li><li><p><span sdata="langKeyword" value="doNotPrompt = true"><span class="keyword">doNotPrompt = true</span></span></p></li></ul></div><h1 class="heading">Примечания</h1><div id="sectionSection0" class="section" name="collapseableSection" style=""><p>В версиях до Драйвер Microsoft JDBC 4.0 для SQL Server приложение должно было указывать встроенную проверку подлинности (по протоколу Kerberos или NTLM, в зависимости от доступности этих протоколов) с помощью свойства соединения <span sdata="langKeyword" value="integratedSecurity"><span class="keyword">integratedSecurity</span></span> и посредством указания библиотеки <span sdata="langKeyword" value="sqljdbc_auth.dll"><span class="keyword">sqljdbc_auth.dll</span></span>, как описано в разделе <span sdata="link"><a href="44996746-d373-4f59-9863-a8a20bb8024a.htm">Формирование URL-адреса соединения</a></span>.</p><p>Начиная с версии Драйвер Microsoft JDBC 4.0 для SQL Server, приложение может с помощью свойства соединения <span sdata="langKeyword" value="authenticationScheme"><span class="keyword">authenticationScheme</span></span> указать, что соединение с базой данных должно выполняться при использовании встроенной проверки подлинности по протоколу Kerberos с использованием реализации этого протокола исключительно на Java:</p><ul><li><p>Если необходимо выполнить встроенную проверку подлинности с помощью модуля <span sdata="langKeyword" value="Krb5LoginModule"><span class="keyword">Krb5LoginModule</span></span>, все еще необходимо указывать свойство соединения <span sdata="langKeyword" value="integratedSecurity=true"><span class="keyword">integratedSecurity=true</span></span>. Следует также указать и свойство соединения <span sdata="langKeyword" value="authenticationScheme=JavaKerberos"><span class="keyword">authenticationScheme=JavaKerberos</span></span>.</p></li><li><p>Чтобы продолжить использование встроенной проверки подлинности с использованием модуля <span sdata="langKeyword" value="sqljdbc_auth.dll"><span class="keyword">sqljdbc_auth.dll</span></span>, просто укажите свойство соединения <span sdata="langKeyword" value="integratedSecurity=true"><span class="keyword">integratedSecurity=true</span></span> (можно также указать <span sdata="langKeyword" value="authenticationScheme=NativeAuthentication"><span class="keyword">authenticationScheme=NativeAuthentication</span></span>).</p></li><li><p>Если указано свойство <span sdata="langKeyword" value="authenticationScheme=JavaKerberos"><span class="keyword">authenticationScheme=JavaKerberos</span></span>, но не указано свойство <span sdata="langKeyword" value="integratedSecurity=true"><span class="keyword">integratedSecurity=true</span></span>, то драйвер не будет использовать свойство соединения <span sdata="langKeyword" value="authenticationScheme"><span class="keyword">authenticationScheme</span></span> и будет искать имя пользователя и пароль в строке подключения.</p></li></ul><p>Если создание соединения выполняется из источника данных, то можно программным способом задать схему проверки подлинности с помощью метода <a href="b942f78e-7ce1-44ef-923d-a7c3d7c76b83.htm">setAuthenticationScheme</a>.</p><p>Для поддержки проверки подлинности по протоколу Kerberos добавлено новое средство ведения журнала — com.microsoft.sqlserver.jdbc.internals.KerbAuthentication. Дополнительные сведения см. в разделе <span sdata="link"><a href="723aeae7-6504-4585-ba8b-3525115bea8b.htm">Трассировка операций драйвера</a></span>.</p><p>Следующие рекомендации помогут настроить протокол Kerberos.</p><ol><li><p>Установите <span sdata="langKeyword" value="AllowTgtSessionKey"><span class="keyword">AllowTgtSessionKey</span></span> в значение 1 в реестре Windows. Дополнительные сведения см. в статье базы знаний <a href="http://support.microsoft.com/kb/837361">Разделы реестра протокола Kerberos и параметры конфигурации KDC в Windows Server 2003</a>.</p></li><li><p>Убедитесь, что конфигурация Kerberos (файл krb5.conf в среде UNIX) содержит верные указания на область (realm) и KDC в вашей среде.</p></li><li><p>Инициализируйте кэш TGT с помощью kinit или войдя в домен.</p></li><li><p>Когда приложение, использующее свойство <span sdata="langKeyword" value="authenticationScheme=JavaKerberos"><span class="keyword">authenticationScheme=JavaKerberos</span></span>, запускается в операционной системе Windows Vista или Windows 7, следует использовать стандартную учетную запись пользователя. Но если приложение запускается от имени учетной записи администратора, то оно должно запускаться с правами доступа администратора.</p></li></ol></div><h1 class="heading">Имена участников-служб</h1><div id="sectionSection1" class="section" name="collapseableSection" style=""><p>Имя участника службы (SPN) — это имя, по которому клиент уникальным образом идентифицирует экземпляр службы. Дополнительные сведения об именах участников служб (SPN) см. в разделах:</p><ul><li><p><a href="http://support.microsoft.com/kb/319723">Как использовать проверку подлинности по протоколу Kerberos в SQL Server</a></p></li><li><p><a href="http://go.microsoft.com/fwlink/?LinkId=207814">Использование протокола Kerberos в SQL Server</a></p></li></ul></div><h1 class="heading">Создание файла конфигурации модуля входа</h1><div id="sectionSection2" class="section" name="collapseableSection" style=""><p>Можно также указать файл конфигурации Kerberos. Если файл конфигурации не указан, то будут действовать следующие настройки:</p><dl class="authored"><dt>Sun JVM</dt><dd><p>com.sun.security.auth.module.Krb5LoginModule required useTicketCache=true doNotPrompt=true;</p></dd><dt>IBM JVM</dt><dd><p>com.ibm.security.auth.module.Krb5LoginModule required useDefaultCcache = true moduleBanner = false;</p></dd></dl><p>Если будет использоваться файл конфигурации модуля входа, то файл должен иметь следующий формат:</p><div class="sampleCode"><span codeLanguage="other"><pre>&lt;<i>name</i>&gt; {
    &lt;<i>LoginModule</i>&gt; &lt;<i>flag</i>&gt; &lt;<i>LoginModule options</i>&gt;;
    &lt;<i>optional_additional_LoginModules</i>, <i>flags_and_options</i>&gt;;
};</pre></span></div><p>Файл конфигурации входа состоит из одной или нескольких записей, каждая из которых описывает, какая из базовых технологий проверки подлинности должна использоваться для конкретного приложения или приложений. Пример:</p><div class="sampleCode"><span codeLanguage="other"><pre>SQLJDBCDriver {
   com.sun.security.auth.module.Krb5LoginModule required useTicketCache=true doNotPrompt=true;
};</pre></span></div><p>Так, каждая запись файла конфигурации модуля входа состоит из имени, за которым следует один или несколько элементов, определяемых модулем входа, причем каждый из этих элементов завершается точкой с запятой, а вся группа заключается в скобки. Каждая запись файла конфигурации завершается точкой с запятой.</p><p>Помимо возможности получения драйвером учетных данных Kerberos согласно настройкам, заданным в файле конфигурации модуля входа, драйвер может использовать существующие учетные данные. Это может оказаться полезным в том случае, когда приложению необходимо создавать соединения с учетными данными нескольких пользователей.</p><p>Драйвер попытается использовать существующие учетные данные, если они доступны, а затем попытается войти с использованием указанного модуля входа. Поэтому при использовании метода Subject.doAs для выполнения кода в определенном контексте будет создано соединение с учетными данными, переданными при вызове Subject.doAs.</p><p>Дополнительные сведения см. в разделе <a href="http://download.oracle.com/javase/1.4.2/docs/guide/security/jaas/tutorials/LoginConfigFile.html">Файл конфигурации входа JAAS</a> и <a href="http://download.oracle.com/javase/1.5.0/docs/guide/security/jgss/tutorials/KerberosReq.html">Класс Krb5LoginModule</a>.</p></div><h1 class="heading">Создание файла конфигурации Kerberos</h1><div id="sectionSection3" class="section" name="collapseableSection" style=""><p>Дополнительные сведения о файлах конфигурации Kerberos см. в разделе <a href="http://download.oracle.com/javase/1.4.2/docs/guide/security/jaas/tutorials/LoginConfigFile.html">Требования Kerberos</a>.</p><p>Ниже приведен образец файла конфигурации домена, где YYYY и ZZZZ — имена доменов на сайте.</p><div class="sampleCode"><span codeLanguage="other"><pre>[libdefaults]
default_realm = YYYY.CORP.CONTOSO.COM
dns_lookup_realm = false
dns_lookup_kdc = true
ticket_lifetime = 24h
forwardable = yes

[domain_realm]
.yyyy.corp.contoso.com = YYYY.CORP.CONTOSO.COM
.zzzz.corp.contoso.com = ZZZZ.CORP.CONTOSO.COM

[realms]
        YYYY.CORP.CONTOSO.COM = {
  kdc = krbtgt/YYYY.CORP. CONTOSO.COM @ YYYY.CORP. CONTOSO.COM
  default_domain = YYYY.CORP. CONTOSO.COM
}

        ZZZZ.CORP. CONTOSO.COM = {
  kdc = krbtgt/ZZZZ.CORP. CONTOSO.COM @ ZZZZ.CORP. CONTOSO.COM
  default_domain = ZZZZ.CORP. CONTOSO.COM
}
</pre></span></div></div><h1 class="heading">Включение файла конфигурации домена и файла конфигурации модуля входа</h1><div id="sectionSection4" class="section" name="collapseableSection" style=""><p>Файл конфигурации домена можно включить с помощью параметра -Djava.security.krb5.conf. Файл конфигурации домена можно включить с помощью параметра <span sdata="langKeyword" value="-Djava.security.auth.login.config"><span class="keyword">-Djava.security.auth.login.config</span></span>.</p><p>Например, при запуске приложения можно указать следующую командную строку:</p><div class="sampleCode"><span codeLanguage="other"><pre>Java.exe -Djava.security.auth.login.config=SQLJDBCDriver.conf -Djava.security.krb5.conf=krb5.ini &lt;<i>APPLICATION_NAME</i>&gt;
</pre></span></div></div><h1 class="heading">Проверка доступности SQL Server по протоколу Kerberos</h1><div id="sectionSection5" class="section" name="collapseableSection" style=""><p>Выполните следующий запрос в среде SQL Server Management Studio:</p><p><span sdata="langKeyword" value="select auth_scheme from sys.dm_exec_connections where session_id=@@spid"><span class="keyword">select auth_scheme from sys.dm_exec_connections where session_id=@@spid</span></span></p><p>Убедитесь, что имеются достаточные разрешения для выполнения этого запроса.</p></div><span id="seeAlsoSpan"><h1 class="heading">См. также</h1></span><div id="seeAlsoSection" class="section" name="collapseableSection" style=""><div class="seeAlsoStyle"><span sdata="link"><a href="94bcfbe3-f00e-4774-bda8-bb7577518fec.htm">Соединение с SQL Server с помощью драйвера JDBC</a></span></div></div></div><div id="footer" class="section"><span id="feedbackarea">Отправить <a href="javascript:SubmitFeedback('DevDocs@Microsoft.com','','','','8.0.12060.10000','%0\dСпасибо%20за%20отзыв!%20Отзывы%20помогают%20команде%20разработчиков%20в%20улучшении%20документации.%20Просматривая%20ваши%20отзывы,%20корпорация%20Майкрософт%20может%20спросить%20по%20электронной%20почте%20ваше%20мнение,%20касающееся%20определенного%20решения.%20Адрес%20электронной%20почты%20не%20используется%20в%20других%20целях%20и%20удаляется%20корпорацией%20Майкрософт%20после%20завершения%20просмотра.%0\AДополнительные%20сведения%20о%20политике%20конфиденциальности%20корпорации%20Майкрософт%20см.%20на%20странице%20http://privacy.microsoft.com/ru-ru/default.aspx.%0\A%0\d','Отзывы%20пользователей.');">отзыв</a> об этом разделе в Майкрософт.</span><span id="copyrightarea"><p><a href="9bad553b-9e70-4696-8499-2e35f772a1e0.htm">© © Корпорация Майкрософт (Microsoft Corporation), 2012 г. Все права защищены.</a></p></span></div></div></body></html>