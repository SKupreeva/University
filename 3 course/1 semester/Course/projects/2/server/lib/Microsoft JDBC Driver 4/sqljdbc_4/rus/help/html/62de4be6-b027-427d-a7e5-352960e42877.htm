<html xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:MSHelp="http://msdn.microsoft.com/mshelp" xmlns:mshelp="http://msdn.microsoft.com/mshelp" xmlns:ddue="http://ddue.schemas.microsoft.com/authoring/2003/5" xmlns:msxsl="urn:schemas-microsoft-com:xslt"><head><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8" /><META NAME="save" CONTENT="history" /><title>Поддержка высокой доступности и аварийного восстановления в драйвере JDBC</title><meta name="Language" content="ru-RU" /><meta name="Microsoft.Help.Id" content="62de4be6-b027-427d-a7e5-352960e42877" /><meta name="Description" content="В этом разделе рассматривается поддержка Драйвер Microsoft JDBC для SQL Server высокой доступности с аварийным восстановлением ― Группы доступности AlwaysOn. Дополнительные сведения о Группы доступности AlwaysOn см." /><meta name="Microsoft.Help.ContentType" content="Concepts" /><link rel="stylesheet" type="text/css" href="../local/Classic.css" /><script type="text/javascript" src="../scripts/EventUtilities.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/SplitScreen.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/Dropdown.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/script_manifold.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/script_feedBack.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/CheckboxMenu.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/CommonUtilities.js">&amp;nbsp;</script><script type="text/javascript" src="../local/script_main.js">&amp;nbsp;</script></head><body><div id="header"><table id="bottomTable" cellpadding="0" cellspacing="0"><tr><td align="left"><span id="headerBold">Поддержка высокой доступности и аварийного восстановления в драйвере JDBC</span></td></tr></table><table id="gradientTable"><tr><td class="nsrBottom" background="../icons/gradient.gif" /></tr></table></div><div id="mainSection"><div id="mainBody"><div class="introduction"><p>В этом разделе рассматривается поддержка Драйвер Microsoft JDBC для SQL Server высокой доступности с аварийным восстановлением ― Группы доступности AlwaysOn. Дополнительные сведения о Группы доступности AlwaysOn см. в электронной документации по SQL Server 2012.</p><p>Начиная с версии 4.0 драйвера Драйвер Microsoft JDBC для SQL Server, в свойствах подключения можно указать прослушиватель группы доступности (аварийного восстановления и высокой готовности). Если приложение Драйвер Microsoft JDBC для SQL Server установило соединение с базой данных AlwaysOn, которая выполняет отработку отказа, то первоначальное соединение разрывается и приложение должно открыть новое соединение, чтобы продолжить работу после обработки отказа.</p><p>Если приложение не установило соединение с прослушивателем группы доступности и если с сервером связано несколько IP-адресов, то драйвер Драйвер Microsoft JDBC для SQL Server пытается установить соединение с первым из них. Если драйвер Драйвер Microsoft JDBC для SQL Server не смог установить соединение с первым IP-адресом, то соединение завершается ошибкой. Драйвер Драйвер Microsoft JDBC для SQL Server не будет повторять попытку соединения с другими IP-адресами, связанными с сервером. При установлении соединения с прослушивателем группы доступности драйвер Драйвер Microsoft JDBC для SQL Server пытается установить соединение со всеми IP-адресами параллельно, и если одна из попыток увенчалась успехом, то драйвер отменяет остальные производимые попытки соединения.</p><div style="margin: .5em 1.5em .5em 1.5em"><b></b><p>Увеличение времени ожидания соединения и реализация логики повторов соединений повышает вероятность того, что приложение установит соединение с группой доступности. Кроме того, поскольку соединение может завершиться ошибкой из-за отработки отказа в группе доступности, необходимо также реализовать логику повторных соединений, которая будет восстанавливать соединение в случае разрыва.</p></div><p>Следующие <a href="f1b62700-f046-488d-bd6b-a5cd8fc345b7.htm">свойства соединения</a> добавлены в версии Драйвер Microsoft JDBC 4.0 для SQL Server:</p><ul><li><p><span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span></p></li><li><p><span sdata="langKeyword" value="applicationIntent"><span class="keyword">applicationIntent</span></span></p></li></ul></div><h1 class="heading">Соединение с MultiSubnetFailover</h1><div id="sectionSection0" class="section" name="collapseableSection" style=""><p>Всегда указывайте <span sdata="langKeyword" value="multiSubnetFailover=true"><span class="keyword">multiSubnetFailover=true</span></span> при соединении с прослушивателем группы доступности SQL Server 2012 или экземпляром отказоустойчивого кластера SQL Server 2012. Свойство <span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> обеспечивает повышение скорости отработки отказа для всех групп доступности и экземпляров отказоустойчивого кластера в SQL Server 2012, а также значительно сокращает время обработки отказа для разных топологий AlwaysOn (как для одной, так и для нескольких подсетей). При отработке отказа в топологии с несколькими подсетями клиент пытается установить соединения параллельно. При отработке отказа Драйвер Microsoft JDBC для SQL Server будет агрессивно повторять попытки соединения по протоколу TCP.</p><p>Свойство соединения <span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> указывает, что приложение развертывается в группе доступности или на экземпляре отказоустойчивого кластера и что драйвер Драйвер Microsoft JDBC для SQL Server попытается установить соединение с базой данных на основном экземпляре SQL Server по всем его IP-адресам. Когда для соединения установлено свойство <span sdata="langKeyword" value="MultiSubnetFailover=true"><span class="keyword">MultiSubnetFailover=true</span></span>, то клиент производит повторные попытки установить TCP-соединение быстрее интервалов повторной отправки TCP-пакетов по умолчанию для операционной системы. Это позволяет после отработки отказа быстрее установить повторное соединение с группой доступности AlwaysOn или экземпляром отказоустойчивого кластера AlwaysOn и применимо к группам доступности и экземплярам отказоустойчивого кластера (как из одной, так и из нескольких подсетей).</p><p>Дополнительные сведения о ключевых словах строки подключения драйвера Драйвер Microsoft JDBC для SQL Server см. в разделе <span sdata="link"><a href="f1b62700-f046-488d-bd6b-a5cd8fc345b7.htm">Задание свойств соединения</a></span>.</p><p>Указание свойства <span sdata="langKeyword" value="multiSubnetFailover=true"><span class="keyword">multiSubnetFailover=true</span></span> при установке соединения с сервером, который не является прослушивателем группы доступности или экземпляром отказоустойчивого кластера, может отрицательно сказаться на производительности работы и поэтому не поддерживается.</p><p>Если диспетчер безопасности не установлен, то виртуальная машина Java кэширует виртуальные IP-адреса (VIP) на ограниченный период времени (по умолчанию определяемый реализацией JDK и свойствами Java networkaddress.cache.ttl и networkaddress.cache.negative.ttl). Если диспетчер безопасности JDK установлен, то виртуальная машина Java будет кэшировать адреса VIP, причем кэш по умолчанию не обновляется. Необходимо установить «время существования» для кэша виртуальной машины Java (networkaddress.cache.ttl) в один день. Если этого не сделать, то старые значения не будут исключаться из кэша виртуальной машины Java при добавлении или обновлении адресов VIP. Дополнительные сведения о параметрах networkaddress.cache.ttl и networkaddress.cache.negative.ttl см. на странице <a href="http://download.oracle.com/javase/6/docs/technotes/guides/net/properties.html">http://download.oracle.com/javase/6/docs/technotes/guides/net/properties.html</a>.</p><p>Следующие рекомендации помогут установить соединение с сервером в группе доступности или на экземпляре отказоустойчивого кластера.</p><ul><li><p>Драйвер выдаст ошибку, если свойство соединения <span sdata="langKeyword" value="instanceName"><span class="keyword">instanceName</span></span> указано в той же строке подключения, что и свойство соединения <span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span>. Это связано с тем, что браузер SQL Server в группе доступности не используется. Однако если также указано свойство соединения <span sdata="langKeyword" value="portNumber"><span class="keyword">portNumber</span></span>, то драйвер не будет использовать свойство <span sdata="langKeyword" value="instanceName"><span class="keyword">instanceName</span></span>, а будет использовать <span sdata="langKeyword" value="portNumber"><span class="keyword">portNumber</span></span>.</p></li><li><p>Пользуйтесь свойством соединения <span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> при установлении соединения с одной или несколькими подсетями, это благоприятно скажется на производительности в любом случае.</p></li><li><p>Чтобы установить соединение с группой доступности, указывайте прослушиватель группы доступности в строке подключения в качестве сервера. Например, jdbc:sqlserver://VNN1.</p></li><li><p>Попытка соединения с экземпляром SQL Server, для которого настроено более 64 IP-адресов, завершится ошибкой.</p></li><li><p>Режим работы приложения, использующего свойство соединения <span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span>, не зависит от типа проверки подлинности — SQL Server, Kerberos или Windows.</p></li><li><p>Увеличьте значение <span sdata="langKeyword" value="loginTimeout"><span class="keyword">loginTimeout</span></span>, чтобы обеспечить отработку отказов и сократить число попыток повторного соединения, предпринимаемых приложением.</p></li><li><p>Распределенные транзакции не поддерживаются.</p></li></ul><p>Если не включена маршрутизация только для чтения, соединение с расположением вторичной реплики в группе доступности завершится ошибкой в следующих случаях.</p><ol><li><p>Если расположение вторичной реплики не настроено на прием соединений.</p></li><li><p>Если в приложении используется свойство <span sdata="langKeyword" value="applicationIntent=ReadWrite"><span class="keyword">applicationIntent=ReadWrite</span></span> (описано ниже), а расположение вторичной реплики настроено только для чтения.</p></li></ol><p>Соединение завершится ошибкой, если первичная реплика настроена на отклонение рабочих нагрузок только для чтения, а строка подключения содержит свойство <span sdata="langKeyword" value="ApplicationIntent=ReadOnly"><span class="keyword">ApplicationIntent=ReadOnly</span></span>.</p></div><h1 class="heading">Переход с зеркального отображения баз данных на использование кластера для нескольких подсетей</h1><div id="sectionSection1" class="section" name="collapseableSection" style=""><p>При обновлении приложения Драйвер Microsoft JDBC для SQL Server, которое в настоящее время использует зеркальное отображение, до сценария с использованием нескольких подсетей необходимо удалить свойство соединения <span sdata="langKeyword" value="failoverPartner"><span class="keyword">failoverPartner</span></span>, заменив его свойством <span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> со значением <span sdata="langKeyword" value="true"><span class="keyword">true</span></span>, а имя сервера в строке подключения — прослушивателем группы доступности. Если соединение использует параметры <span sdata="langKeyword" value="failoverPartner"><span class="keyword">failoverPartner</span></span> и <span sdata="langKeyword" value="multiSubnetFailover=true"><span class="keyword">multiSubnetFailover=true</span></span>, то драйвер выдаст ошибку. Но если в строке подключения указано <span sdata="langKeyword" value="failoverPartner"><span class="keyword">failoverPartner</span></span> и <span sdata="langKeyword" value="multiSubnetFailover=false"><span class="keyword">multiSubnetFailover=false</span></span> (или <span sdata="langKeyword" value="ApplicationIntent=ReadWrite"><span class="keyword">ApplicationIntent=ReadWrite</span></span>), то приложение будет использовать зеркальное отображение баз данных.</p><p>Драйвер вернет ошибку, если зеркальное отображение базы данных используется для базы данных-источника в группе доступности, а свойство <span sdata="langKeyword" value="multiSubnetFailover=true"><span class="keyword">multiSubnetFailover=true</span></span> указано в строке подключения для соединения с базой данных-источником, а не с прослушивателем группы доступности.</p></div><h1 class="heading">Указание намерения приложения</h1><div id="sectionSection2" class="section" name="collapseableSection" style=""><p>Когда указано свойство <span sdata="langKeyword" value="applicationIntent=ReadOnly"><span class="keyword">applicationIntent=ReadOnly</span></span>, при соединении с базой данных AlwaysOn клиент запрашивает рабочую нагрузку только для чтения. Сервер принудительно применяет намерение при установке соединения и при выполнении инструкции USE, но только для баз данных, поддерживающих AlwaysOn.</p><p>Ключевое слово <span sdata="langKeyword" value="applicationIntent"><span class="keyword">applicationIntent</span></span> не работает с устаревшими базами данных только для чтения.</p><p>База данных может разрешить или запретить рабочие нагрузки только для чтения в целевых базах данных AlwaysOn. (это реализуется предложением <span sdata="langKeyword" value="ALLOW_CONNECTIONS"><span class="keyword">ALLOW_CONNECTIONS</span></span> инструкций <span sdata="langKeyword" value="PRIMARY_ROLE"><span class="keyword">PRIMARY_ROLE</span></span> и <span sdata="langKeyword" value="SECONDARY_ROLE"><span class="keyword">SECONDARY_ROLE</span></span> Transact-SQL).</p><p>Ключевое слово <span sdata="langKeyword" value="applicationIntent"><span class="keyword">applicationIntent</span></span> служит для включения маршрутизации только для чтения.</p></div><h1 class="heading">Маршрутизация только для чтения</h1><div id="sectionSection3" class="section" name="collapseableSection" style=""><p>Маршрутизация только для чтения — это функция, которая способна обеспечить доступность реплики базы данных только для чтения. Включение маршрутизации только для чтения</p><ol><li><p>Необходимо установить соединение с прослушивателем группы доступности AlwaysOn.</p></li><li><p>Ключевое слово <span sdata="langKeyword" value="applicationIntent"><span class="keyword">applicationIntent</span></span> в строке подключения должно быть установлено в значение <span sdata="langKeyword" value="ReadOnly"><span class="keyword">ReadOnly</span></span>.</p></li><li><p> Группа доступности должна быть настроена администратором базы данных для включения маршрутизации только для чтения.</p></li></ol><p>Возможно, что несколько соединений с маршрутизацией только для чтения подключатся не к одной и той же реплике только для чтения. Изменения в синхронизации базы данных или конфигурации маршрутизации сервера могут привести к тому, что клиенты будут подключены к различным репликам только для чтения. Чтобы гарантировать, что все запросы на соединения только для чтения будут поступать к одной и той же реплике только для чтения, не указывайте прослушиватель группы доступности или виртуальный IP-адрес в ключевом слове <span sdata="langKeyword" value="serverName"><span class="keyword">serverName</span></span> строки подключения. Вместо этого укажите имя экземпляра только для чтения.</p><p>Маршрутизация только для чтения может занять больше времени, чем подключение к источнику, так как при этом сначала производится соединение с источником, а затем поиск наилучшего, доступного для чтения получателя. Поэтому необходимо увеличить время ожидания соединения.</p></div><h1 class="heading">Новые методы, поддерживающие multiSubnetFailover и applicationIntent</h1><div id="sectionSection4" class="section" name="collapseableSection" style=""><p>Следующие методы обеспечивают программный доступ к ключевым словам <span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> и <span sdata="langKeyword" value="applicationIntent"><span class="keyword">applicationIntent</span></span> строки подключения:</p><ul><li><p><a href="19411e6c-c456-4533-8252-54569a2a6b1f.htm">SQLServerDataSource.getApplicationIntent</a></p></li><li><p><a href="e164c8ac-a0ae-4638-affb-ed454e7c0708.htm">SQLServerDataSource.setApplicationIntent</a></p></li><li><p><a href="1e8cb175-5f4c-4208-b4f5-3646990a30e3.htm">SQLServerDataSource.getMultiSubnetFailover</a></p></li><li><p><a href="7ffd282d-c2f6-4d1b-a7a6-859d18b388aa.htm">SQLServerDataSource.setMultiSubnetFailover</a></p></li><li><p><a href="b5eaad8a-31ef-44ac-af11-d5caa13ac3e2.htm">SQLServerDriver.getPropertyInfo</a></p></li></ul><p>Методы <span sdata="langKeyword" value="getMultiSubnetFailover"><span class="keyword">getMultiSubnetFailover</span></span>, <span sdata="langKeyword" value="setMultiSubnetFailover"><span class="keyword">setMultiSubnetFailover</span></span>, <span sdata="langKeyword" value="getApplicationIntent"><span class="keyword">getApplicationIntent</span></span> и <span sdata="langKeyword" value="setApplicationIntent"><span class="keyword">setApplicationIntent</span></span> также добавлены в интерфейс <span sdata="link"><a href="097434fd-2b74-411c-a5ed-eba04481dde5.htm">Класс SQLServerDataSource Class</a></span>, класс <span sdata="link"><a href="b00e5a90-2af7-4d04-8ef8-256183777dcf.htm">Класс SQLServerConnectionPoolDataSource</a></span> и класс <span sdata="link"><a href="95fc7b07-2498-4a7e-8f7f-ee0d86b598b4.htm">Класс SQLServerXADataSource</a></span>.</p></div><h1 class="heading">Проверка сертификатов SSL</h1><div id="sectionSection5" class="section" name="collapseableSection" style=""><p>Группа доступности состоит из нескольких физических серверов. В драйвер Драйвер Microsoft JDBC 4.0 для SQL Server добавлена поддержка имен <span sdata="langKeyword" value="Subject Alternate Name"><span class="keyword">Subject Alternate Name</span></span> в сертификатах SSL, чтобы несколько узлов можно было связать с одним и тем же сертификатом. Дополнительные сведения о протоколе SSL см. в разделе <span sdata="link"><a href="073f3b9e-8edd-4815-88ea-de0655d0325e.htm">Основные сведения о поддержке SSL</a></span>.</p></div><span id="seeAlsoSpan"><h1 class="heading">См. также</h1></span><div id="seeAlsoSection" class="section" name="collapseableSection" style=""><div class="seeAlsoStyle"><span sdata="link"><a href="f1b62700-f046-488d-bd6b-a5cd8fc345b7.htm">Задание свойств соединения</a></span></div><div class="seeAlsoStyle"><span sdata="link"><a href="94bcfbe3-f00e-4774-bda8-bb7577518fec.htm">Соединение с SQL Server с помощью драйвера JDBC</a></span></div></div></div><div id="footer" class="section"><span id="feedbackarea">Отправить <a href="javascript:SubmitFeedback('DevDocs@Microsoft.com','','','','8.0.12060.10000','%0\dСпасибо%20за%20отзыв!%20Отзывы%20помогают%20команде%20разработчиков%20в%20улучшении%20документации.%20Просматривая%20ваши%20отзывы,%20корпорация%20Майкрософт%20может%20спросить%20по%20электронной%20почте%20ваше%20мнение,%20касающееся%20определенного%20решения.%20Адрес%20электронной%20почты%20не%20используется%20в%20других%20целях%20и%20удаляется%20корпорацией%20Майкрософт%20после%20завершения%20просмотра.%0\AДополнительные%20сведения%20о%20политике%20конфиденциальности%20корпорации%20Майкрософт%20см.%20на%20странице%20http://privacy.microsoft.com/ru-ru/default.aspx.%0\A%0\d','Отзывы%20пользователей.');">отзыв</a> об этом разделе в Майкрософт.</span><span id="copyrightarea"><p><a href="9bad553b-9e70-4696-8499-2e35f772a1e0.htm">© © Корпорация Майкрософт (Microsoft Corporation), 2012 г. Все права защищены.</a></p></span></div></div></body></html>